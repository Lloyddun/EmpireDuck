<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EmpireDuck - Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, updateDoc, increment, collection, addDoc, getDocs, query, orderBy, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyB5doP59G7ZTYfkYE1wFm4Q8mlYRnfGZzs",
          authDomain: "empireduck-44605.firebaseapp.com",
          projectId: "empireduck-44605",
          storageBucket: "empireduck-44605.firebasestorage.app",
          messagingSenderId: "75285864312",
          appId: "1:75285864312:web:341490cbe836a25fbef28d"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            window.db = db;
            window.auth = auth;
            window.appId = 'empireduck-live'; 
            window.doc = doc;
            window.collection = collection;
            window.addDoc = addDoc;
            window.deleteDoc = deleteDoc;
            window.getDocs = getDocs;
            window.updateDoc = updateDoc;
            window.increment = increment;
            window.onSnapshot = onSnapshot;
            window.setDoc = setDoc;
            window.getDoc = getDoc;
            window.query = query;
            window.orderBy = orderBy;
            window.limit = limit;
            window.signInWithEmailAndPassword = signInWithEmailAndPassword;
            window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
            window.signOut = signOut;

            onAuthStateChanged(auth, (user) => {
                const loader = document.getElementById('globalLoader');
                if (user) {
                    window.currentUserEmail = user.email;
                    window.currentUserId = user.uid;
                    enterGame(user.uid, user.email);
                } else {
                    document.getElementById('authView').classList.remove('hidden');
                    document.getElementById('gameView').classList.add('hidden');
                    document.getElementById('navBar').classList.add('hidden');
                }
                if(loader) loader.classList.add('hidden');
            });

        } catch (e) {
            console.error("Erreur Init Firebase:", e);
            alert("Erreur critique Firebase: " + e.message);
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');

        body {
            font-family: 'Fredoka', sans-serif;
            user-select: none;
            overflow: hidden;
            touch-action: manipulation;
            background-color: #0f172a;
        }

        .warehouse-bg {
            background-color: #451a03;
            background-image: repeating-linear-gradient(45deg, #78350f 25%, transparent 25%, transparent 75%, #78350f 75%, #78350f), repeating-linear-gradient(45deg, #78350f 25%, transparent 25%, transparent 75%, #78350f 75%, #78350f);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
            box-shadow: inset 0 0 150px #000;
        }

        .coop-area {
            background-color: #3f1d0b;
            border-top: 4px dashed #cd853f;
            box-shadow: inset 0 10px 20px rgba(0,0,0,0.8);
            position: relative;
        }

        .duck-sprite {
            position: absolute;
            font-size: 1.8rem;
            z-index: 10;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .duck-sprite:active { transform: scale(1.2); }

        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
        
        .nav-item.active { color: #fbbf24; border-top: 2px solid #fbbf24; background-color: rgba(30, 41, 59, 0.5); }
        .bg-airtel { background-color: #e30613; } .text-airtel { color: #e30613; } .border-airtel { border-color: #e30613; }
        .bg-telegram { background-color: #229ED9; }

        .loader-overlay { background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(5px); }
    </style>
</head>
<body class="bg-slate-900 h-screen w-screen flex flex-col text-slate-100">

    <!-- LOADER -->
    <div id="globalLoader" class="fixed inset-0 z-[300] bg-slate-900 flex items-center justify-center">
        <div class="text-center">
            <div class="text-4xl animate-bounce mb-2">ü¶Ü</div>
            <p class="text-slate-500 text-xs uppercase tracking-widest">Connexion...</p>
        </div>
    </div>

    <!-- AUTH -->
    <div id="authView" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-slate-900 p-6">
        <div class="w-full max-w-sm bg-slate-800 p-8 rounded-2xl shadow-xl border border-slate-700 relative">
            <h1 class="text-3xl font-bold text-orange-500 text-center mb-1">EmpireDuck</h1>
            <p class="text-slate-500 text-xs text-center mb-6 uppercase tracking-widest">Connexion Requise</p>
            
            <div class="flex mb-4 bg-slate-900 rounded p-1">
                <button onclick="toggleAuth('login')" id="tabLogin" class="flex-1 py-2 text-xs font-bold rounded bg-slate-700 text-white transition-colors">Connexion</button>
                <button onclick="toggleAuth('register')" id="tabReg" class="flex-1 py-2 text-xs font-bold rounded text-slate-500 transition-colors">Inscription</button>
            </div>

            <div class="space-y-3">
                <input type="email" id="authEmail" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-sm focus:border-orange-500 outline-none transition-colors" placeholder="Email (Gmail)*">
                <input type="password" id="authPass" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-sm focus:border-orange-500 outline-none transition-colors" placeholder="Mot de passe (6+)*">
                <input type="password" id="authConf" class="hidden w-full bg-slate-900 border border-slate-600 rounded p-3 text-sm focus:border-orange-500 outline-none transition-colors" placeholder="Confirmer MDP*">
                
                <div id="authError" class="text-red-400 text-xs text-center p-2 bg-red-900/20 rounded border border-red-900 hidden"></div>
                
                <button onclick="handleAuth()" id="authBtn" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-transform">SE CONNECTER</button>
            </div>
        </div>
    </div>

    <!-- JEU -->
    <div id="gameView" class="hidden flex-grow flex-col h-full relative">
        <div class="bg-slate-800 p-2 shadow-xl flex justify-between items-center z-30 shrink-0 border-b border-slate-600 min-h-[70px]">
            <div class="flex flex-col justify-center gap-1">
                <div class="text-[10px] text-slate-400 px-2 py-0.5 rounded border border-slate-700 bg-slate-900 inline-block w-fit truncate max-w-[100px]">
                    <i class="fa-solid fa-user-circle mr-1"></i><span id="uName">Joueur</span>
                </div>
                <button onclick="upgradeBasket()" class="bg-blue-600 text-white text-[9px] py-1 px-2 rounded border-b-2 border-blue-800 active:border-b-0 mt-0.5 whitespace-nowrap active:scale-95">
                    Panier +50 <span class="text-yellow-300 ml-1" id="upCost">50üí∞</span>
                </button>
            </div>
            
            <div class="flex gap-2 items-center">
                <div id="basketBox" class="bg-slate-700 w-16 md:w-28 h-10 rounded border-2 border-slate-500 relative overflow-hidden flex items-center justify-center">
                    <div id="basketBar" class="absolute bottom-0 left-0 w-full bg-blue-500 opacity-50 h-0 transition-all duration-300"></div>
                    <div class="relative z-10 text-center leading-none">
                        <div class="text-[8px] text-slate-300 uppercase font-bold">Stock</div>
                        <div class="text-xs font-bold text-white"><span id="eggsDisp">0</span>/<span id="maxDisp">50</span></div>
                    </div>
                </div>

                <button onclick="sellEggs()" class="h-10 bg-green-600 text-white font-bold px-3 rounded border-b-4 border-green-800 active:border-b-0 text-xs flex flex-col items-center justify-center active:scale-95">
                    <span>VENDRE</span>
                    <span id="valDisp" class="text-[9px] text-green-100 font-mono">Min 30</span>
                </button>

                <div class="h-10 px-2 bg-yellow-900/80 rounded border-2 border-yellow-500 flex items-center justify-center min-w-[60px]">
                    <span id="coinDisp" class="font-bold text-white text-sm">0</span> <span class="text-xs ml-1">üí∞</span>
                </div>
            </div>
        </div>

        <div id="warehouse" class="relative flex-grow warehouse-bg overflow-hidden flex flex-col">
            <a href="https://t.me/+A9ZIQNBWCZM4NzRk" target="_blank" class="absolute top-4 right-4 z-40 bg-telegram text-white p-2 rounded-full shadow-lg border-2 border-white/20 hover:scale-110 transition-transform">
                <i class="fa-brands fa-telegram text-2xl"></i>
            </a>

            <div class="flex-grow flex items-center justify-center p-4 text-center opacity-50 pointer-events-none">
                <div id="startHint" class="hidden">
                    <i class="fa-solid fa-arrow-down text-3xl mb-2"></i>
                    <p class="text-xs">Faites un d√©p√¥t pour commencer !</p>
                </div>
            </div>

            <div id="coop" class="coop-area h-[45%] min-h-[150px] w-full relative overflow-hidden shrink-0">
                <div class="absolute top-2 left-2 bg-black/40 px-2 py-1 rounded text-[10px] text-orange-200 z-20 border border-orange-900/30">
                    Enclos (<span id="duckCount">0</span>)
                </div>
            </div>

            <div id="brokenOverlay" class="hidden absolute inset-0 bg-red-900/95 z-[60] flex flex-col items-center justify-center px-4 text-center">
                <div class="text-5xl mb-2">üí•</div>
                <h2 class="text-2xl font-bold text-white uppercase">PANIER CRAQU√â !</h2>
                <p class="text-red-200 text-xs mb-4">Stock perdu (trop d'≈ìufs).<br>Revenez plus souvent !</p>
                <button onclick="cleanMess()" class="bg-white text-red-900 px-6 py-2 rounded-full font-bold text-sm shadow-lg">NETTOYER</button>
            </div>
        </div>

        <div class="bg-slate-900 p-2 shrink-0 border-t-4 border-slate-700 h-auto pb-20">
            <div class="flex gap-2 overflow-x-auto hide-scroll pb-safe" id="shopList"></div>
        </div>
    </div>

    <!-- D√âP√îT -->
    <div id="depositView" class="hidden flex-grow flex-col bg-slate-900 overflow-y-auto pb-24 pt-4 px-4">
        <h2 class="text-center text-xl font-bold text-green-500 mb-1">Recharger</h2>
        <p class="text-center text-slate-500 text-xs mb-4">500 Pi√®ces pour 5$ (Min)</p>
        <div class="max-w-md mx-auto w-full space-y-4">
            <div class="bg-slate-800 p-4 rounded-xl border border-slate-600">
                <label class="text-xs text-slate-400 font-bold uppercase block mb-1">Montant √† d√©poser ($ USD)</label>
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-xl font-bold text-green-500">$</span>
                    <input type="number" id="depAmountUSD" value="5" min="5" class="w-full bg-slate-900 text-white text-lg font-bold p-2 border-b-2 border-green-500 outline-none" oninput="calcDeposit()">
                </div>
                <div class="flex justify-between text-xs text-slate-400 border-t border-slate-700 pt-2">
                    <span>Soit environ:</span>
                    <span class="text-white font-bold"><span id="depEstFCFA">3275</span> FCFA</span>
                </div>
                <div class="flex justify-between text-xs text-slate-400 mt-1">
                    <span>Vous recevrez (1$ = 100 Pi√®ces):</span>
                    <span class="text-yellow-400 font-bold"><span id="depEstCoins">500</span> Pi√®ces</span>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="setDepMethod('tron')" id="btnDepTron" class="p-3 rounded border border-red-500 bg-red-900/20 text-red-400 text-xs font-bold ring-2 ring-red-500">Crypto (TRX)</button>
                <button onclick="setDepMethod('mobile')" id="btnDepMob" class="p-3 rounded border border-slate-600 bg-slate-800 text-slate-400 text-xs font-bold">Mobile Money</button>
            </div>
            <div id="depFormTron" class="space-y-3">
                <div class="bg-slate-800 p-3 rounded border border-red-500/30">
                    <p class="text-[10px] text-slate-400 mb-1">Adresse de d√©p√¥t (TRC20) :</p>
                    <div class="flex gap-2 items-center">
                        <code class="block bg-black/30 p-2 rounded text-[10px] text-slate-300 truncate flex-1 select-all font-mono">TCQq5HjiWVHhiWdnSU3aPY7ewQAoB3rrCf</code>
                        <button class="bg-slate-700 px-3 py-2 rounded text-xs hover:bg-slate-600" onclick="copyAddr()"><i class="fa-regular fa-copy"></i></button>
                    </div>
                </div>
                <div>
                    <input type="text" id="depHash" placeholder="Coller le Hash de transaction ici *" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-xs focus:border-green-500 outline-none">
                    <p class="text-[10px] text-slate-500 mt-1 pl-1"><i class="fa-solid fa-clock"></i> Temps de validation : ~45 secondes</p>
                </div>
            </div>
            <div id="depFormMobile" class="hidden space-y-3">
                <div class="bg-slate-800 p-3 rounded border border-airtel">
                    <p class="text-center font-bold text-airtel mb-1 text-xl" id="mobAmountDisplay">3275 FCFA</p>
                    <p class="text-[10px] text-slate-400 text-center">Envoyer au <span class="text-white font-bold text-sm">077408087</span></p>
                </div>
                <input type="text" id="depMobId" placeholder="ID Transaction (Preuve) *" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-xs focus:border-airtel outline-none">
                <input type="tel" id="depMobNum" placeholder="Votre Num√©ro *" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-xs focus:border-airtel outline-none">
                <p class="text-[10px] text-slate-500 mt-1 pl-1"><i class="fa-solid fa-clock"></i> Temps de validation : ~1 minute</p>
            </div>
            <button onclick="submitDeposit()" id="btnSubmitDep" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg border-b-4 border-green-800 active:border-b-0 active:translate-y-1">JE CONFIRME LE PAIEMENT</button>
        </div>
    </div>

    <!-- RETRAIT -->
    <div id="withdrawView" class="hidden flex-grow flex-col bg-slate-900 overflow-y-auto pb-24 pt-4 px-4">
        <h2 class="text-center text-xl font-bold text-red-500 mb-1">Retrait</h2>
        <p class="text-center text-slate-500 text-xs mb-4">Traitement sous 24h</p>
        <div class="max-w-md mx-auto w-full space-y-4">
            <div class="bg-slate-800 p-4 rounded-xl flex justify-between items-center border border-slate-600">
                <span class="text-xs text-slate-400 font-bold uppercase">Solde Dispo</span>
                <span class="text-xl font-bold text-yellow-400"><span id="wBal">0</span> üí∞</span>
            </div>
            <div class="bg-slate-800/50 p-3 rounded text-[10px] text-slate-400 text-center border border-dashed border-slate-600">
                1000 Pi√®ces = 1500 FCFA | 0.000723 TRX
            </div>
            <div>
                <label class="text-[10px] text-slate-400 uppercase font-bold mb-1 block">Montant (Min 1000)</label>
                <input type="number" id="wAmount" placeholder="Ex: 1000" class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-sm focus:border-blue-500 outline-none text-white" oninput="calcWithdraw()">
            </div>
            <div class="flex justify-between items-center bg-black/20 p-3 rounded border border-slate-700">
                <span class="text-xs text-slate-400">Net apr√®s frais (<span id="wFeeTxt">0%</span>) :</span>
                <span id="wEst" class="font-bold text-white text-sm">0 FCFA</span>
            </div>
            <div>
                <label class="text-[10px] text-slate-400 uppercase font-bold mb-1 block">Mode de r√©ception</label>
                <select id="wMethod" class="w-full bg-slate-800 border border-slate-600 rounded p-3 text-xs mb-2 text-white" onchange="calcWithdraw()">
                    <option value="airtel">Airtel Money (13% frais)</option>
                    <option value="tron">Crypto TRON (1% frais)</option>
                </select>
                <input type="text" id="wAddr" placeholder="Num√©ro ou Adresse..." class="w-full bg-slate-900 border border-slate-600 rounded p-3 text-sm focus:border-blue-500 outline-none text-white">
            </div>
            <button onclick="submitWithdraw()" id="wBtn" disabled class="w-full bg-red-600 hover:bg-red-500 disabled:bg-slate-700 disabled:text-slate-500 disabled:cursor-not-allowed text-white font-bold py-4 rounded-xl shadow-lg border-b-4 border-red-800 active:border-b-0 active:translate-y-1">DEMANDER LE RETRAIT</button>
            <div id="wHistory" class="space-y-2 mt-4 text-xs text-slate-500"></div>
        </div>
    </div>

    <!-- √âQUIPE -->
    <div id="referralView" class="hidden flex-grow flex-col bg-slate-900 overflow-y-auto pb-24 pt-4 px-4">
        <h2 class="text-center text-xl font-bold text-yellow-400 mb-4">Mon √âquipe</h2>
        <div class="max-w-md mx-auto w-full space-y-4">
            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                <label class="text-[10px] text-slate-400 uppercase font-bold mb-2 block">Votre lien de parrainage</label>
                <div class="flex gap-2">
                    <input type="text" id="refLink" readonly class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-xs text-slate-300 truncate font-mono">
                    <button onclick="copyRef()" class="bg-blue-600 hover:bg-blue-500 px-3 rounded text-white text-xs"><i class="fa-regular fa-copy"></i></button>
                </div>
                <p class="text-[10px] text-green-400 mt-2"><i class="fa-solid fa-check"></i> Commissions de 2 √† 20 Pi√®ces</p>
            </div>
            <div class="bg-gradient-to-r from-yellow-900 to-slate-900 p-4 rounded-xl border border-yellow-500/50 flex justify-between items-center shadow-lg">
                <div>
                    <div class="text-[10px] text-yellow-200 uppercase">Commissions en attente</div>
                    <div class="text-2xl font-bold text-white"><span id="refBal">0</span> üí∞</div>
                </div>
                <button onclick="claimRef()" id="btnRefClaim" disabled class="bg-yellow-500 hover:bg-yellow-400 disabled:bg-slate-700 disabled:text-slate-500 text-black font-bold py-2 px-4 rounded text-xs shadow-md">R√âCLAMER</button>
            </div>
            <div>
                <h3 class="text-xs font-bold text-slate-500 uppercase border-b border-slate-700 pb-1 mb-2">Derniers √©v√©nements</h3>
                <div id="refLogs" class="space-y-2">
                    <div class="text-center text-[10px] text-slate-600 italic py-4">En attente d'activit√© filleul...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminView" class="hidden flex-grow flex-col bg-slate-900 overflow-y-auto z-[200]">
        <div class="bg-red-900 p-4 border-b border-red-700 flex justify-between items-center sticky top-0 z-10">
            <h1 class="text-xl font-bold text-white"><i class="fa-solid fa-shield-halved mr-2"></i>ADMIN PANEL</h1>
            <button onclick="window.location.reload()" class="bg-red-700 px-3 py-1 rounded text-xs">D√©connexion</button>
        </div>
        <div class="p-4 space-y-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <div class="text-xs text-slate-400 uppercase">Total Crypto</div>
                    <div class="text-2xl font-bold text-green-400" id="admTotalCrypto">0 $</div>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <div class="text-xs text-slate-400 uppercase">Total Mobile</div>
                    <div class="text-2xl font-bold text-blue-400" id="admTotalMobile">0 FCFA</div>
                </div>
            </div>
            
            <!-- Liste des D√©p√¥ts -->
            <div>
                <h3 class="text-white font-bold mb-2 border-b border-slate-700 pb-1">Historique des D√©p√¥ts</h3>
                <div id="admDepositsList" class="space-y-2 text-xs">
                    <div class="text-slate-500 italic">Chargement...</div>
                </div>
            </div>

            <!-- Gestion Retraits -->
            <div>
                <h3 class="text-white font-bold mb-2 border-b border-slate-700 pb-1">Demandes de Retrait</h3>
                <div id="admWithdrawList" class="space-y-2 text-xs">
                    <div class="text-slate-500 italic">Chargement...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- NAV -->
    <div id="navBar" class="hidden fixed bottom-0 w-full bg-slate-900 border-t border-slate-700 h-16 grid grid-cols-4 z-50 shadow-2xl">
        <button onclick="nav('game')" id="nGame" class="nav-item active flex flex-col items-center justify-center text-slate-500"><i class="fa-solid fa-industry mb-1 text-lg"></i><span class="text-[9px] font-bold">USINE</span></button>
        <button onclick="nav('deposit')" id="nDep" class="nav-item flex flex-col items-center justify-center text-slate-500"><i class="fa-solid fa-wallet mb-1 text-lg"></i><span class="text-[9px] font-bold">D√âP√îT</span></button>
        <button onclick="nav('withdraw')" id="nWith" class="nav-item flex flex-col items-center justify-center text-slate-500"><i class="fa-brands fa-tron mb-1 text-lg"></i><span class="text-[9px] font-bold">RETRAIT</span></button>
        <button onclick="nav('referral')" id="nRef" class="nav-item flex flex-col items-center justify-center text-slate-500 relative"><i class="fa-solid fa-users mb-1 text-lg"></i><span class="text-[9px] font-bold">√âQUIPE</span><div id="refPing" class="hidden absolute top-3 right-5 w-2 h-2 bg-yellow-400 rounded-full animate-ping"></div></button>
    </div>

    <!-- MODAL -->
    <div id="modal" class="hidden fixed inset-0 bg-black/90 z-[90] flex items-center justify-center p-4">
        <div class="bg-slate-800 p-6 rounded-xl border border-slate-600 w-full max-w-xs text-center shadow-2xl">
            <h3 id="mTitle" class="text-lg font-bold text-white mb-2">Titre</h3>
            <p id="mMsg" class="text-sm text-slate-300 mb-6">Message</p>
            <button onclick="document.getElementById('modal').classList.add('hidden')" class="bg-slate-700 hover:bg-slate-600 w-full py-3 rounded text-white font-bold">FERMER</button>
        </div>
    </div>

    <script>
        // CONFIG
        const DUCKS = [
            { id: 1, name: "Poussin", cost: 150, val: 0.5, rate: 30000, emoji: 'üê•', comm: 2 },
            { id: 2, name: "Colvert", cost: 600, val: 2.5, rate: 25000, emoji: 'ü¶Ü', comm: 5 },
            { id: 3, name: "Oie", cost: 2500, val: 12.5, rate: 20000, emoji: 'ü¶¢', comm: 10 },
            { id: 4, name: "Dor√©", cost: 12000, val: 75, rate: 15000, emoji: 'üëë', comm: 15 },
            { id: 5, name: "Cyborg", cost: 30000, val: 200, rate: 10000, emoji: 'ü§ñ', comm: 18 },
            { id: 6, name: "Quantum", cost: 60000, val: 500, rate: 5000, emoji: '‚öõÔ∏è', comm: 20 }
        ];

        const TRX_PER_1000 = 0.000723;
        const FCFA_PER_1000 = 1500;
        const COINS_PER_USD = 100;

        let state = { coins: 0, eggs: 0, pendingVal: 0, basketMax: 50, basketLvl: 1, ducks: [], refEarn: 0 };
        const navIds = { game: 'nGame', deposit: 'nDep', withdraw: 'nWith', referral: 'nRef' };
        let isRegistering = false;
        let duckIntervals = [];

        // AUTH
        window.toggleAuth = function(mode) {
            isRegistering = (mode === 'register');
            document.getElementById('authConf').classList.toggle('hidden', !isRegistering);
            document.getElementById('authBtn').textContent = isRegistering ? "S'INSCRIRE" : "SE CONNECTER";
            document.getElementById('tabLogin').className = !isRegistering ? "flex-1 py-2 text-xs font-bold rounded bg-slate-700 text-white" : "flex-1 py-2 text-xs font-bold rounded text-slate-500";
            document.getElementById('tabReg').className = isRegistering ? "flex-1 py-2 text-xs font-bold rounded bg-slate-700 text-white" : "flex-1 py-2 text-xs font-bold rounded text-slate-500";
            document.getElementById('authError').classList.add('hidden');
        }

        window.handleAuth = async function() {
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            const errDiv = document.getElementById('authError');
            
            if(!email || pass.length < 6) {
                errDiv.textContent = "Email valide et mot de passe (6+) requis.";
                errDiv.classList.remove('hidden');
                return;
            }

            if(email === 'Viva123@gmail.com' && pass === 'admin2006') {
                openAdminPanel();
                return;
            }

            if(isRegistering && pass !== document.getElementById('authConf').value) {
                errDiv.textContent = "Les mots de passe ne correspondent pas.";
                errDiv.classList.remove('hidden');
                return;
            }

            document.getElementById('authBtn').textContent = "Chargement...";
            
            try {
                if (!window.auth) throw new Error("Firebase non initialis√©");
                if (isRegistering) await window.createUserWithEmailAndPassword(window.auth, email, pass);
                else await window.signInWithEmailAndPassword(window.auth, email, pass);
            } catch (error) {
                console.error(error);
                let msg = "Erreur de connexion (" + error.code + ")";
                if(error.code === 'auth/email-already-in-use') msg = "Cet email est d√©j√† utilis√©.";
                if(error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') msg = "Email ou mot de passe incorrect.";
                if(error.code === 'auth/user-not-found') msg = "Compte inexistant. Inscrivez-vous.";
                
                errDiv.textContent = msg;
                errDiv.classList.remove('hidden');
                document.getElementById('authBtn').textContent = isRegistering ? "S'INSCRIRE" : "SE CONNECTER";
            }
        }

        window.enterGame = function(uid, email) {
            if(email === 'Viva123@gmail.com') { openAdminPanel(); return; }
            document.getElementById('uName').textContent = email.split('@')[0];
            document.getElementById('authView').classList.add('hidden');
            document.getElementById('gameView').classList.remove('hidden');
            document.getElementById('gameView').classList.add('flex');
            document.getElementById('navBar').classList.remove('hidden');
            document.getElementById('refLink').value = window.location.origin + "?ref=" + uid.substring(0, 10);
            updateUI(); 
            loadGame(uid);
            initGameLoop(uid);
            initReferralSim();
        }

        window.doLogout = function() {
            window.signOut(window.auth).then(() => {
                window.location.reload();
            });
        }

        function openAdminPanel() {
            document.getElementById('authView').classList.add('hidden');
            document.getElementById('adminView').classList.remove('hidden');
            document.getElementById('adminView').classList.add('flex');
            
            // Stats
            window.onSnapshot(window.doc(window.db, 'artifacts', window.appId, 'admin', 'stats'), (snap) => {
                if(snap.exists()) {
                    const d = snap.data();
                    document.getElementById('admTotalCrypto').textContent = (d.cryptoDep || 0) + ' $';
                    document.getElementById('admTotalMobile').textContent = (d.mobileDep || 0) + ' FCFA';
                }
            });

            // Historique D√©p√¥ts
            const depQuery = window.query(window.collection(window.db, 'artifacts', window.appId, 'admin_deposits'), window.orderBy('date', 'desc'), window.limit(20));
            window.onSnapshot(depQuery, (snap) => {
                const div = document.getElementById('admDepositsList');
                div.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    div.innerHTML += `
                        <div class="bg-slate-700 p-2 rounded border border-slate-600 text-xs mb-1">
                            <div class="flex justify-between font-bold text-white">
                                <span>${d.amount}</span>
                                <span>${d.method}</span>
                            </div>
                            <div class="text-slate-400 text-[10px]">${d.user}</div>
                            <div class="text-slate-500 text-[9px] truncate">${d.ref || '-'}</div>
                            <div class="text-right text-yellow-500 text-[9px]">${new Date(d.date).toLocaleString()}</div>
                        </div>
                    `;
                });
                if(snap.empty) div.innerHTML = '<div class="text-slate-500">Aucun d√©p√¥t r√©cent.</div>';
            });

            // Gestion Retraits
            const wQuery = window.query(window.collection(window.db, 'artifacts', window.appId, 'withdrawals'), window.orderBy('date', 'desc'));
            window.onSnapshot(wQuery, (snap) => {
                const div = document.getElementById('admWithdrawList');
                div.innerHTML = '';
                snap.forEach(docSnap => {
                    const d = docSnap.data();
                    if(d.status === 'pending') { // Afficher seulement les pending
                        const uid = d.uid; // Assurer qu'on a bien l'uid sauvegard√©
                        div.innerHTML += `
                            <div class="bg-slate-800 p-2 rounded border border-yellow-600 text-xs mb-2">
                                <div class="flex justify-between font-bold text-white mb-1">
                                    <span>${d.amount} P</span>
                                    <span class="text-orange-400">${d.method}</span>
                                </div>
                                <div class="text-slate-300 text-[10px] mb-1">User: ${d.email}</div>
                                <div class="text-slate-400 text-[9px] bg-black/30 p-1 rounded mb-2">${d.address}</div>
                                <div class="flex gap-2">
                                    <button onclick="window.handleAdminWithdraw('${docSnap.id}', 'approve')" class="flex-1 bg-green-600 text-white py-1 rounded hover:bg-green-500">‚úÖ Payer</button>
                                    <button onclick="window.handleAdminWithdraw('${docSnap.id}', 'reject', '${uid}', ${d.amount})" class="flex-1 bg-red-600 text-white py-1 rounded hover:bg-red-500">‚ùå Refuser</button>
                                </div>
                            </div>
                        `;
                    }
                });
                if(snap.empty) div.innerHTML = '<div class="text-slate-500">Aucune demande en attente.</div>';
            });
        }

        window.handleAdminWithdraw = async function(docId, action, uid, amount) {
            try {
                if (action === 'approve') {
                    // Juste supprimer la demande (consid√©r√©e comme pay√©e)
                    await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'withdrawals', docId));
                    alert("Retrait marqu√© comme pay√©.");
                } else if (action === 'reject') {
                    // Rembourser l'utilisateur
                    const userDoc = window.doc(window.db, 'artifacts', window.appId, 'users', uid, 'data');
                    await window.updateDoc(userDoc, {
                        coins: window.increment(amount)
                    });
                    // Supprimer la demande
                    await window.deleteDoc(window.doc(window.db, 'artifacts', window.appId, 'withdrawals', docId));
                    alert("Retrait refus√©. Utilisateur rembours√©.");
                }
            } catch (e) {
                console.error("Erreur admin:", e);
                alert("Erreur lors de l'action: " + e.message);
            }
        }

        // LOGIC
        function loadGame(uid) {
            const userDoc = window.doc(window.db, 'artifacts', window.appId, 'users', uid, 'data');
            window.onSnapshot(userDoc, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(Math.abs(data.coins - state.coins) > 1) state.coins = data.coins;
                    if(data.ducks && JSON.stringify(data.ducks) !== JSON.stringify(state.ducks)) {
                        clearDucks();
                        state.ducks = data.ducks;
                        state.ducks.forEach(d => {
                            const conf = DUCKS.find(c => c.id === d.typeId);
                            if(conf) spawnDuckVisual(conf);
                        });
                    }
                    state.basketMax = data.basketMax || 50;
                    state.basketLvl = data.basketLvl || 1;
                    state.refEarn = data.refEarn || 0;
                } else {
                    saveGame(uid);
                }
                updateUI();
            });
        }

        function saveGame(uid) {
            if (!uid) uid = window.currentUserId;
            if (!uid) return;
            const userDoc = window.doc(window.db, 'artifacts', window.appId, 'users', uid, 'data');
            window.setDoc(userDoc, {
                coins: state.coins,
                basketMax: state.basketMax,
                basketLvl: state.basketLvl,
                ducks: state.ducks,
                refEarn: state.refEarn,
                lastSave: Date.now()
            }, { merge: true });
        }

        function initGameLoop(uid) { setInterval(() => saveGame(uid), 15000); }

        window.buyDuck = function(id) {
            const d = DUCKS.find(x => x.id === id);
            if(state.coins >= d.cost) {
                state.coins -= d.cost;
                state.ducks.push({ id: Date.now(), typeId: id });
                spawnDuckVisual(d);
                saveGame();
                updateUI();
            }
        }

        function clearDucks() {
            duckIntervals.forEach(clearInterval);
            duckIntervals = [];
            document.getElementById('coop').innerHTML = '<div class="absolute top-2 left-2 bg-black/40 px-2 py-1 rounded text-[10px] text-orange-200 z-20 border border-orange-900/30">Enclos (<span id="duckCount">0</span>)</div>';
        }

        function spawnDuckVisual(conf) {
            const el = document.createElement('div');
            el.className = 'duck-sprite select-none';
            el.textContent = conf.emoji;
            el.style.left = (Math.random() * 80 + 5) + '%';
            el.style.top = (Math.random() * 80 + 5) + '%';
            document.getElementById('coop').appendChild(el);
            const int = setInterval(() => layEgg(conf.val), conf.rate);
            duckIntervals.push(int);
        }

        function layEgg(val) {
            if(state.eggs >= state.basketMax) {
                document.getElementById('brokenOverlay').classList.remove('hidden');
                state.eggs = 0;
                state.pendingVal = 0;
            } else {
                state.eggs++;
                state.pendingVal += val;
            }
            updateUI();
        }

        window.sellEggs = function() {
            if(state.eggs < 30) {
                showModal("Stock Insuffisant", "Il faut au moins 30 ≈ìufs pour vendre.");
                return;
            }
            state.coins += state.pendingVal;
            state.eggs = 0;
            state.pendingVal = 0;
            saveGame();
            updateUI();
        }

        window.cleanMess = function() {
            document.getElementById('brokenOverlay').classList.add('hidden');
            state.eggs = 0;
            state.pendingVal = 0;
            saveGame();
            updateUI();
        }

        window.upgradeBasket = function() {
            const cost = Math.floor(50 * Math.pow(1.5, state.basketLvl - 1));
            if(state.coins >= cost) {
                state.coins -= cost;
                state.basketLvl++;
                state.basketMax += 50;
                saveGame();
                updateUI();
            }
        }

        function updateUI() {
            document.getElementById('coinDisp').textContent = Math.floor(state.coins);
            document.getElementById('eggsDisp').textContent = state.eggs;
            document.getElementById('maxDisp').textContent = state.basketMax;
            const val = state.pendingVal;
            document.getElementById('valDisp').textContent = val > 0 ? Math.floor(val) + 'üí∞' : 'Min 30';
            const countEl = document.getElementById('duckCount');
            if(countEl) countEl.textContent = state.ducks.length;
            const wBal = document.getElementById('wBal');
            if(wBal) wBal.textContent = Math.floor(state.coins);
            const refBal = document.getElementById('refBal');
            if(refBal) refBal.textContent = state.refEarn;

            const pct = Math.min((state.eggs/state.basketMax)*100, 100);
            const bar = document.getElementById('basketBar');
            if(bar) {
                bar.style.height = pct + '%';
                bar.className = pct >= 90 ? "absolute bottom-0 left-0 w-full bg-red-600 h-full transition-all duration-300" : "absolute bottom-0 left-0 w-full bg-blue-500 opacity-50 transition-all duration-300";
            }
            
            const bBox = document.getElementById('basketBox');
            if(bBox) {
                if(pct >= 90) bBox.classList.add('danger-mode');
                else bBox.classList.remove('danger-mode');
            }

            const upCost = Math.floor(50 * Math.pow(1.5, state.basketLvl - 1));
            document.getElementById('upCost').textContent = upCost + 'üí∞';

            renderShop();
            
            if(state.coins < 150 && state.ducks.length === 0) document.getElementById('startHint').classList.remove('hidden');
            else document.getElementById('startHint').classList.add('hidden');
        }

        function renderShop() {
            const cont = document.getElementById('shopList');
            cont.innerHTML = '';
            DUCKS.forEach(d => {
                const can = state.coins >= d.cost;
                const div = document.createElement('div');
                div.className = `shrink-0 w-28 bg-slate-800 rounded p-2 border-2 ${can ? 'border-slate-500' : 'border-slate-700 opacity-60'} flex flex-col items-center gap-1`;
                div.innerHTML = `
                    <div class="flex justify-between w-full text-xs text-slate-400"><span>${d.name}</span></div>
                    <div class="text-2xl">${d.emoji}</div>
                    <div class="text-xs text-center text-slate-500">${(d.rate/1000).toFixed(1)}s</div>
                    <button onclick="buyDuck(${d.id})" ${can?'':'disabled'} class="w-full text-xs font-bold py-1 rounded ${can?'bg-green-600 text-white':'bg-slate-700 text-slate-500'}">${d.cost}üí∞</button>
                `;
                cont.appendChild(div);
            });
        }

        let depMethod = 'tron';
        window.setDepMethod = function(m) {
            depMethod = m;
            document.getElementById('btnDepTron').className = m==='tron' ? "p-3 rounded border border-red-500 bg-red-900/20 text-red-400 text-xs font-bold ring-2 ring-red-500" : "p-3 rounded border border-slate-600 bg-slate-800 text-slate-400 text-xs font-bold";
            document.getElementById('btnDepMob').className = m==='mobile' ? "p-3 rounded border border-airtel bg-red-900/10 text-airtel text-xs font-bold ring-2 ring-airtel" : "p-3 rounded border border-slate-600 bg-slate-800 text-slate-400 text-xs font-bold";
            document.getElementById('depFormTron').classList.toggle('hidden', m!=='tron');
            document.getElementById('depFormMobile').classList.toggle('hidden', m!=='mobile');
        }

        window.calcDeposit = function() {
            const usd = parseFloat(document.getElementById('depAmountUSD').value) || 0;
            const fcfa = Math.floor(usd * 655);
            const coinsEst = Math.floor(usd * COINS_PER_USD);
            document.getElementById('depEstFCFA').textContent = fcfa;
            document.getElementById('depEstCoins').textContent = coinsEst;
            document.getElementById('mobAmountDisplay').textContent = fcfa + ' FCFA';
        }

        window.copyAddr = function() {
            navigator.clipboard.writeText('TCQq5HjiWVHhiWdnSU3aPY7ewQAoB3rrCf');
            showModal("Info", "Adresse copi√©e !");
        }

        window.submitDeposit = function() {
            const usd = parseFloat(document.getElementById('depAmountUSD').value);
            if(usd < 5) { showModal("Erreur", "Minimum $5.00"); return; }
            
            const valid = depMethod === 'tron' ? document.getElementById('depHash').value.length > 8 : (document.getElementById('depMobId').value.length > 2 && document.getElementById('depMobNum').value.length > 5);
            if(!valid) { showModal("Erreur", "Preuves de paiement requises."); return; }

            const btn = document.getElementById('btnSubmitDep');
            const originalText = "JE CONFIRME LE PAIEMENT";
            let waitTime = depMethod === 'tron' ? 45 : 60; // 45s Crypto, 60s Mobile
            
            btn.disabled = true;
            btn.className = "w-full bg-slate-700 text-slate-400 font-bold py-4 rounded-xl cursor-not-allowed";
            
            const timer = setInterval(() => {
                waitTime--;
                btn.textContent = `V√©rification... ${waitTime}s`;
                if(waitTime <= 0) {
                    clearInterval(timer);
                    const fcfa = Math.floor(usd * 655);
                    const coinsToAdd = Math.floor(usd * COINS_PER_USD);
                    state.coins += coinsToAdd;
                    saveGame();
                    
                    // Stats Admin + Historique
                    const statsDoc = window.doc(window.db, 'artifacts', window.appId, 'admin', 'stats');
                    const depAmt = depMethod === 'tron' ? usd + ' $' : fcfa + ' FCFA';
                    const depRef = document.getElementById(depMethod === 'tron' ? 'depHash' : 'depMobId').value;
                    
                    if(depMethod === 'tron') window.setDoc(statsDoc, { cryptoDep: window.increment(usd) }, { merge: true });
                    else window.setDoc(statsDoc, { mobileDep: window.increment(fcfa) }, { merge: true });

                    // Add History Doc
                    window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'admin_deposits'), {
                        user: window.currentUserEmail,
                        amount: depAmt,
                        method: depMethod,
                        ref: depRef,
                        date: Date.now()
                    });

                    updateUI();
                    window.nav('game');
                    btn.textContent = originalText;
                    btn.disabled = false;
                    btn.className = "w-full bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg";
                    showModal("Paiement Re√ßu", `+${coinsToAdd} Pi√®ces ajout√©es au solde.`);
                    document.getElementById('depHash').value = '';
                    document.getElementById('depMobId').value = '';
                }
            }, 1000);
        }

        window.calcWithdraw = function() {
            const amt = parseInt(document.getElementById('wAmount').value) || 0;
            const method = document.getElementById('wMethod').value;
            let valStr = "";
            let feeTxt = "";
            
            if(method === 'airtel') {
                const gross = (amt / 1000) * FCFA_PER_1000;
                const net = Math.floor(gross * 0.87); 
                valStr = net + " FCFA";
                feeTxt = "13%";
            } else {
                const gross = (amt / 1000) * TRX_PER_1000;
                const net = (gross * 0.99).toFixed(8);
                valStr = net + " TRX";
                feeTxt = "1%";
            }
            document.getElementById('wEst').textContent = valStr;
            document.getElementById('wFeeTxt').textContent = feeTxt;
            document.getElementById('wBtn').disabled = !(amt >= 1000 && amt <= state.coins && document.getElementById('wAddr').value.length > 5);
        }

        window.submitWithdraw = function() {
            const amt = parseInt(document.getElementById('wAmount').value);
            const addr = document.getElementById('wAddr').value;
            const method = document.getElementById('wMethod').value;
            state.coins -= amt;
            saveGame();
            updateUI();
            
            window.addDoc(window.collection(window.db, 'artifacts', window.appId, 'withdrawals'), {
                uid: window.currentUserId, // Add this for refund
                email: window.currentUserEmail,
                amount: amt,
                method: method,
                address: addr,
                date: Date.now(),
                status: 'pending'
            });

            showModal("Demande Envoy√©e", "Le virement sera effectu√© sous 24h.");
            const hist = document.getElementById('wHistory');
            hist.innerHTML = `<div>- ${amt} coins <span class="text-orange-500">En cours (24h)</span></div>` + hist.innerHTML;
            document.getElementById('wAmount').value = '';
            calcWithdraw();
        }

        function initReferralSim() {
            setInterval(() => {
                if(Math.random() > 0.8) { 
                    const duck = DUCKS[Math.floor(Math.random() * DUCKS.length)];
                    const comm = duck.comm;
                    state.refEarn += comm;
                    const l = document.getElementById('refLogs');
                    l.innerHTML = `<div class="bg-slate-800 p-2 rounded text-[10px] flex justify-between border border-slate-700"><span>Achat Filleul (${duck.name})</span><span class="text-green-400 font-bold">+${comm}üí∞</span></div>` + l.innerHTML;
                    if(document.getElementById('referralView').classList.contains('hidden')) {
                        document.getElementById('refPing').classList.remove('hidden');
                    }
                    updateUI();
                }
            }, 15000); 
        }

        window.copyRef = function() {
            navigator.clipboard.writeText(document.getElementById('refLink').value);
            showModal("Info", "Lien copi√© !");
        }

        window.claimRef = function() {
            state.coins += state.refEarn;
            state.refEarn = 0;
            saveGame();
            updateUI();
            document.getElementById('refPing').classList.add('hidden');
        }

        window.nav = function(tab) {
            ['game','deposit','withdraw','referral'].forEach(t => {
                document.getElementById(t+'View').classList.add('hidden');
                const navId = navIds[t];
                if(document.getElementById(navId)) document.getElementById(navId).classList.remove('active');
            });
            const v = document.getElementById(tab+'View');
            if(v) v.classList.remove('hidden');
            if(tab !== 'game' && v) v.classList.add('flex');
            const activeNav = document.getElementById(navIds[tab]);
            if(activeNav) activeNav.classList.add('active');
            if(tab==='withdraw') calcWithdraw();
            if(tab==='deposit') calcDeposit();
        }

        function showModal(title, msg) {
            document.getElementById('mTitle').textContent = title;
            document.getElementById('mMsg').textContent = msg;
            document.getElementById('modal').classList.remove('hidden');
        }
    </script>
</body>
</html>


